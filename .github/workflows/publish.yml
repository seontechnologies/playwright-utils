name: Publish Package

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version type to bump'
        required: true
        default: 'patch'
        type: 'choice'
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        description: 'Custom version (if version_type is "custom")'
        required: false
        type: 'string'

permissions:
  contents: write # Required for checkout and pushing changes
  packages: write # Required for publishing to GitHub Packages
  pull-requests: write # Required for creating PRs

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for version calculation

      # 2. Setup Node.js with caching
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc' # Verified correct for v4
          registry-url: 'https://npm.pkg.github.com/'
          scope: '@seontechnologies'
          cache: 'npm' # Use built-in caching

      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4. Validate code
      - name: Run tests and validation
        run: npm run validate

      # (Tag-based publishing removed as requested)

      # 5. Validate custom version input if provided
      - name: Validate inputs
        run: |
          if [[ "${{ github.event.inputs.version_type }}" == "custom" ]]; then
            if [[ -z "${{ github.event.inputs.custom_version }}" ]]; then
              echo "ERROR: custom_version must be provided when version_type=custom"
              exit 1
            fi
          fi

      # 6. Configure git
      - name: Configure git
        run: |
          git config --global user.name "SEON CI Bot"
          git config --global user.email "ci-bot@seon.io"

      # 7. Calculate and set version
      - name: Calculate version
        id: version
        run: |
          # Get current version
          CURRENT_VERSION=$(npm pkg get version | tr -d '"')
          echo "Current version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Determine version
          if [[ "${{ github.event.inputs.version_type }}" == "custom" ]]; then
            NEW_VERSION="${{ github.event.inputs.custom_version }}"
            echo "Setting custom version: $NEW_VERSION"
          else
            # Use standard semver with a robust increment approach
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
            PATCH_BASE="${PATCH%%-*}" # Remove anything after a dash
            
            if [[ "${{ github.event.inputs.version_type }}" == "major" ]]; then
              NEW_MAJOR=$((MAJOR + 1))
              NEW_VERSION="$NEW_MAJOR.0.0"
            elif [[ "${{ github.event.inputs.version_type }}" == "minor" ]]; then
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="$MAJOR.$NEW_MINOR.0"
            else
              NEW_PATCH=$((PATCH_BASE + 1))
              NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
            fi
            
            echo "Setting semver version: $NEW_VERSION"
          fi

          # Guard against no-op version bump
          if [[ "$NEW_VERSION" == "$CURRENT_VERSION" ]]; then
            echo "Version is already $NEW_VERSION, nothing to do."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Update package.json version
          npm version "$NEW_VERSION" --no-git-tag-version

          # Verify version was set
          UPDATED_VERSION=$(npm pkg get version | tr -d '"')
          echo "New version: $UPDATED_VERSION"
          echo "new_version=$UPDATED_VERSION" >> $GITHUB_OUTPUT
          echo "release_branch=release/v$UPDATED_VERSION" >> $GITHUB_OUTPUT

      # 8. Build and publish package
      - name: Build and publish
        if: steps.version.outputs.skip != 'true'
        run: |
          # Build the package
          npm run build

          # Create .npmrc file with authentication token directly
          echo "@seontechnologies:registry=https://npm.pkg.github.com/" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.PERSONAL_GITHUB_TOKEN }}" >> .npmrc

          # Publish with the explicit .npmrc file
          npm publish
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

      # 9. Create git commit, tag and branch
      - name: Create commit and branch
        if: steps.version.outputs.skip != 'true'
        run: |
          # Commit the version change
          git add package.json package-lock.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
          git tag -a "v${{ steps.version.outputs.new_version }}" -m "Release ${{ steps.version.outputs.new_version }}"

          # Create a branch for this release
          git checkout -b "${{ steps.version.outputs.release_branch }}"

          # Push the release branch and tag
          git push origin "${{ steps.version.outputs.release_branch }}"
          git push origin "v${{ steps.version.outputs.new_version }}"

      # 10. Create pull request (letting GitHub CLI use GH_TOKEN automatically)
      - name: Create pull request
        if: steps.version.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        run: |
          echo "Creating pull request for version ${{ steps.version.outputs.new_version }}"

          # Create PR and capture URL directly (GH_TOKEN is automatically used)
          PR_URL=$(gh pr create \
            --base main \
            --head "${{ steps.version.outputs.release_branch }}" \
            --title "chore: release v${{ steps.version.outputs.new_version }}" \
            --body "This PR updates the package version to ${{ steps.version.outputs.new_version }}. This was automatically generated by the publish workflow.")

          # Display URL to created PR
          echo "Pull request URL: $PR_URL"
