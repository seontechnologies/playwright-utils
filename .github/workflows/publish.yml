name: Publish Package

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version type to bump'
        required: true
        default: 'patch'
        type: 'choice'
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        description: 'Custom version (if version_type is "custom")'
        required: false
        type: 'string'

permissions:
  contents: write # Required for checkout and pushing changes
  pull-requests: write # Required for creating PRs
  packages: write # Required for publishing to GitHub Packages

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for version calculation

      # 2. Setup Node.js with caching
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc' # Verified correct for v4
          registry-url: 'https://registry.npmjs.org'
          scope: '@seontechnologies'
          cache: 'npm' # Use built-in caching

      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      # 5. Validate custom version input if provided
      - name: Validate inputs
        env:
          VERSION_TYPE: ${{ github.event.inputs.version_type }}
          CUSTOM_VERSION: ${{ github.event.inputs.custom_version }}
        run: |
          if [[ "$VERSION_TYPE" == "custom" ]]; then
            if [[ -z "$CUSTOM_VERSION" ]]; then
              echo "ERROR: custom_version must be provided when version_type=custom"
              exit 1
            fi
          fi

      # 6. Configure git
      - name: Configure git
        run: |
          git config --global user.name "SEON CI Bot"
          git config --global user.email "ci-bot@seon.io"

      # 7. Calculate and set version
      - name: Calculate version
        id: version
        env:
          VERSION_TYPE: ${{ github.event.inputs.version_type }}
          CUSTOM_VERSION: ${{ github.event.inputs.custom_version }}
        run: |
          # Get current version
          CURRENT_VERSION=$(npm pkg get version | tr -d '"')
          echo "Current version: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Determine version
          if [[ "$VERSION_TYPE" == "custom" ]]; then
            NEW_VERSION="$CUSTOM_VERSION"
            echo "Setting custom version: $NEW_VERSION"
          else
            # Use standard semver with a robust increment approach
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
            PATCH_BASE="${PATCH%%-*}" # Remove anything after a dash

            if [[ "$VERSION_TYPE" == "major" ]]; then
              NEW_MAJOR=$((MAJOR + 1))
              NEW_VERSION="$NEW_MAJOR.0.0"
            elif [[ "$VERSION_TYPE" == "minor" ]]; then
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="$MAJOR.$NEW_MINOR.0"
            else
              NEW_PATCH=$((PATCH_BASE + 1))
              NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
            fi

            echo "Setting semver version: $NEW_VERSION"
          fi

          # Guard against no-op version bump
          if [[ "$NEW_VERSION" == "$CURRENT_VERSION" ]]; then
            echo "Version is already $NEW_VERSION, nothing to do."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Update package.json version
          npm version "$NEW_VERSION" --no-git-tag-version

          # Verify version was set
          UPDATED_VERSION=$(npm pkg get version | tr -d '"')
          echo "New version: $UPDATED_VERSION"
          echo "new_version=$UPDATED_VERSION" >> $GITHUB_OUTPUT
          echo "release_branch=release/v$UPDATED_VERSION" >> $GITHUB_OUTPUT

      # 8. Build the package
      - name: Build package
        if: steps.version.outputs.skip != 'true'
        run: npm run build

      # 9. Setup Node for npmjs.org and publish
      - name: Setup Node.js for npmjs.org
        if: steps.version.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          registry-url: 'https://registry.npmjs.org'
          scope: '@seontechnologies'

      - name: Check npmjs.org registry
        if: steps.version.outputs.skip != 'true'
        id: npmjs
        run: |
          if npm view @seontechnologies/playwright-utils@${{ steps.version.outputs.new_version }} --registry=https://registry.npmjs.org >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish to npmjs.org
        if: steps.version.outputs.skip != 'true' && steps.npmjs.outputs.exists != 'true'
        run: |
          echo "Publishing version ${{ steps.version.outputs.new_version }} to npmjs.org..."
          npm publish --ignore-scripts --registry=https://registry.npmjs.org
          echo "Successfully published ${{ steps.version.outputs.new_version }} to npmjs.org"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PCKG_PUBLISHER }}

      - name: Skip npmjs.org publish (already exists)
        if: steps.version.outputs.skip != 'true' && steps.npmjs.outputs.exists == 'true'
        run: echo "Version ${{ steps.version.outputs.new_version }} already exists on npmjs.org, skipping publish."

      # 10. Setup Node for GitHub Packages and publish
      - name: Setup Node.js for GitHub Packages
        if: steps.version.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@seontechnologies'

      - name: Check GitHub Packages registry
        if: steps.version.outputs.skip != 'true'
        id: github
        run: |
          if npm view @seontechnologies/playwright-utils@${{ steps.version.outputs.new_version }} --registry=https://npm.pkg.github.com >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Packages
        if: steps.version.outputs.skip != 'true' && steps.github.outputs.exists != 'true'
        run: |
          echo "Publishing version ${{ steps.version.outputs.new_version }} to GitHub Packages..."
          # Override .npmrc to use GitHub Packages for @seontechnologies scope
          echo "@seontechnologies:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> .npmrc
          npm publish --ignore-scripts
          echo "Successfully published ${{ steps.version.outputs.new_version }} to GitHub Packages"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

      - name: Skip GitHub Packages publish (already exists)
        if: steps.version.outputs.skip != 'true' && steps.github.outputs.exists == 'true'
        run: echo "Version ${{ steps.version.outputs.new_version }} already exists on GitHub Packages, skipping publish."

      # Restore original .npmrc for subsequent steps
      - name: Restore .npmrc
        if: steps.version.outputs.skip != 'true'
        run: echo "@seontechnologies:registry=https://registry.npmjs.org" > .npmrc

      # 11. Verify both publishes succeeded
      - name: Verify publish on npmjs.org
        if: steps.version.outputs.skip != 'true'
        run: |
          echo "Verifying package ${{ steps.version.outputs.new_version }} is available..."
          sleep 5  # Brief wait for registries to update
          npm view @seontechnologies/playwright-utils@${{ steps.version.outputs.new_version }} --registry=https://registry.npmjs.org version && echo "✓ Verified on npmjs.org"

      - name: Verify publish on GitHub Packages
        if: steps.version.outputs.skip != 'true'
        run: |
          npm view @seontechnologies/playwright-utils@${{ steps.version.outputs.new_version }} --registry=https://npm.pkg.github.com version && echo "✓ Verified on GitHub Packages"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 12. Create git commit, tag and branch
      - name: Create commit and branch
        if: steps.version.outputs.skip != 'true'
        run: |
          # Commit the version change
          git add package.json package-lock.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
          git tag -a "v${{ steps.version.outputs.new_version }}" -m "Release ${{ steps.version.outputs.new_version }}"

          # Create a branch for this release
          git checkout -b "${{ steps.version.outputs.release_branch }}"

          # Push the release branch and tag
          git push origin "${{ steps.version.outputs.release_branch }}"
          git push origin "v${{ steps.version.outputs.new_version }}"

      # 13. Create pull request
      - name: Create pull request
        if: steps.version.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Creating pull request for version ${{ steps.version.outputs.new_version }}"

          # Create PR and capture URL directly (GH_TOKEN is automatically used)
          PR_URL=$(gh pr create \
            --base main \
            --head "${{ steps.version.outputs.release_branch }}" \
            --title "chore: release v${{ steps.version.outputs.new_version }}" \
            --body "This PR updates the package version to ${{ steps.version.outputs.new_version }}. This was automatically generated by the publish workflow.")

          # Display URL to created PR
          echo "Pull request URL: $PR_URL"
